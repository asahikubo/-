<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修正依頼管理システム</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>修正依頼管理システム</h1>
            <p class="version">スプレッドシート版 - 複数人で共有可能 (Ver.02)</p>
        </header>

        <!-- 入力フォーム -->
        <div class="form-section">
            <h2>新規修正依頼</h2>
            <form id="requestForm">
                <div class="form-group">
                    <label for="page">修正ページ:</label>
                    <select id="page" required>
                        <option value="">選択してください</option>
                        <option value="トップページ">トップページ</option>
                        <option value="商品一覧">商品一覧</option>
                        <option value="商品詳細">商品詳細</option>
                        <option value="お問い合わせ">お問い合わせ</option>
                        <option value="会社概要">会社概要</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date">記入日:</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label for="content">修正内容:</label>
                    <textarea id="content" rows="4" required placeholder="修正内容を詳しく記入してください"></textarea>
                </div>

                <div class="form-group">
                    <label for="priority">優先度:</label>
                    <select id="priority" required>
                        <option value="">選択してください</option>
                        <option value="高">高</option>
                        <option value="中">中</option>
                        <option value="低">低</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="category">修正カテゴリ:</label>
                    <select id="category" required>
                        <option value="">選択してください</option>
                        <option value="修正">修正</option>
                        <option value="追加">追加</option>
                        <option value="削除">削除</option>
                        <option value="変更">変更</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="image">画像アップロード:</label>
                    <small id="imageHelp" style="display: none; color: #666; margin-bottom: 5px;">※
                        画像を変更する場合のみ選択してください。選択しない場合は既存の画像が保持されます。</small>
                    <input type="file" id="image" accept="image/*">
                    <div id="dropZone" class="drop-zone">
                        <p>ここに画像をドラッグ&ドロップ<br>または<br>Ctrl+V でペースト</p>
                    </div>
                    <div id="imagePreview"></div>
                </div>

                <button type="submit" class="submit-btn">登録</button>
                <div id="loading" class="loading" style="display: none;">保存中...</div>
            </form>
        </div>

        <!-- タブ表示エリア -->
        <div class="tabs-section">
            <h2>修正依頼一覧</h2>
            <div class="tabs" id="pageTabs"></div>
            <div class="tab-content" id="tabContent"></div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9sjGXUsrUPnoPaTbZnGCh21-O-Msfi3rjbNRMpMahtm5kJ7j4se87wNY96hzNNcfvdQ/exec';

        // データ管理クラス
        class RequestManager {
            constructor() {
                this.requests = [];
                this.currentEditId = null;
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setCurrentDate();
                await this.loadRequests();
                this.renderTabs();
                this.renderRequests();
            }

            setupEventListeners() {
                const form = document.getElementById('requestForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSubmit();
                    });
                }

                const imageInput = document.getElementById('image');
                if (imageInput) {
                    imageInput.addEventListener('change', (e) => {
                        this.handleImagePreview(e);
                    });
                }

                // ドラッグ&ドロップ機能
                this.setupDragAndDrop();
                
                // コピー&ペースト機能
                this.setupPasteFunction();
            }

            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').value = today;
            }

            async handleSubmit() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';

                try {
                    const formData = await this.getFormData();

                    if (this.currentEditId) {
                        await this.updateRequest(this.currentEditId, formData);
                        this.currentEditId = null;
                    } else {
                        await this.addRequest(formData);
                    }

                    this.resetForm();
                    await this.loadRequests();
                    this.renderTabs();
                    this.renderRequests();

                    alert('保存が完了しました！');
                } catch (error) {
                    console.error('保存エラー:', error);
                    
                    let errorMessage = '保存に失敗しました。';
                    if (error.message.includes('too large')) {
                        errorMessage = '画像が大きすぎます。より小さな画像を使用してください。';
                    } else if (error.message.includes('timeout')) {
                        errorMessage = 'タイムアウトしました。ネットワーク接続を確認してください。';
                    }
                    
                    alert(errorMessage + '\nローカルストレージに保存します。');
                    
                    // フォールバック: ローカルストレージに保存
                    const formData = await this.getFormData();
                    this.requests.push(formData);
                    this.saveToLocalStorage();
                    this.renderTabs();
                    this.renderRequests();
                } finally {
                    loading.style.display = 'none';
                }
            }

            async getFormData() {
                const imageFile = document.getElementById('image').files[0];
                let imageData = null;
                let imageName = null;

                if (imageFile) {
                    imageData = await this.fileToBase64(imageFile);
                    imageName = imageFile.name;
                } else if (this.currentEditId) {
                    const existingRequest = this.requests.find(req => req.id === this.currentEditId);
                    if (existingRequest) {
                        imageData = existingRequest.imageData;
                        imageName = existingRequest.imageName;
                    }
                }

                return {
                    id: this.currentEditId || Date.now().toString(),
                    page: document.getElementById('page').value,
                    date: document.getElementById('date').value,
                    content: document.getElementById('content').value,
                    priority: document.getElementById('priority').value,
                    category: document.getElementById('category').value,
                    imageData: imageData,
                    imageName: imageName,
                    createdAt: new Date().toISOString()
                };
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    // ファイルサイズが1MBを超える場合は圧縮
                    if (file.size > 1024 * 1024) {
                        this.compressImage(file).then(resolve).catch(reject);
                    } else {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    }
                });
            }

            compressImage(file) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // 最大サイズを800x600に制限
                        const maxWidth = 800;
                        const maxHeight = 600;
                        let { width, height } = img;
                        
                        // アスペクト比を保持してリサイズ
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // 画像を描画
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 圧縮してBase64に変換（品質0.7）
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        console.log(`画像を圧縮しました: ${file.size} bytes → ${Math.round(compressedDataUrl.length * 0.75)} bytes`);
                        resolve(compressedDataUrl);
                    };
                    
                    img.onerror = reject;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // JSONP方式でGoogle Apps Scriptにアクセス
            jsonpRequest(url, params = {}) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

                    // コールバック関数を作成
                    window[callbackName] = function (data) {
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        resolve(data);
                    };

                    // パラメータにコールバック名を追加
                    params.callback = callbackName;

                    // URLの長さをチェック
                    const queryString = Object.keys(params)
                        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                        .join('&');
                    
                    const fullUrl = url + '?' + queryString;
                    
                    // URLが長すぎる場合はエラー
                    if (fullUrl.length > 8000) {
                        console.error('URL too long:', fullUrl.length, 'characters');
                        reject(new Error('Request too large - please use smaller image'));
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = fullUrl;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        reject(new Error('JSONP request failed - possibly too large'));
                    };

                    document.body.appendChild(script);

                    // タイムアウト設定
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            reject(new Error('JSONP request timeout'));
                        }
                    }, 20000); // タイムアウトを20秒に延長
                });
            }

            async addRequest(requestData) {
                try {
                    console.log('スプレッドシートに保存中...', {
                        ...requestData,
                        imageData: requestData.imageData ? `[画像データ: ${Math.round(requestData.imageData.length / 1024)}KB]` : null
                    });
                    
                    // 画像データが大きすぎる場合の警告
                    if (requestData.imageData && requestData.imageData.length > 100000) {
                        console.warn('大きな画像データを送信中:', Math.round(requestData.imageData.length / 1024), 'KB');
                    }
                    
                    const response = await this.jsonpRequest(SCRIPT_URL, {
                        action: 'add',
                        data: JSON.stringify(requestData)
                    });

                    console.log('スプレッドシートからの応答:', JSON.stringify(response, null, 2));

                    if (response.status === 'success') {
                        console.log('スプレッドシートに保存成功:', JSON.stringify(response, null, 2));
                        // ローカルデータも更新
                        this.requests.push(requestData);
                        this.saveToLocalStorage();
                        return response;
                    } else {
                        throw new Error(response.message || 'スプレッドシートへの保存に失敗');
                    }
                } catch (error) {
                    console.error('スプレッドシート保存エラー:', error);
                    
                    // 画像データが原因の場合は画像なしで再試行
                    if (error.message.includes('too large') && requestData.imageData) {
                        console.log('画像データが大きすぎるため、画像なしで再試行します');
                        try {
                            const dataWithoutImage = { ...requestData, imageData: null, imageName: null };
                            const retryResponse = await this.jsonpRequest(SCRIPT_URL, {
                                action: 'add',
                                data: JSON.stringify(dataWithoutImage)
                            });
                            
                            if (retryResponse.status === 'success') {
                                console.log('画像なしでの保存に成功しました');
                                this.requests.push(dataWithoutImage);
                                this.saveToLocalStorage();
                                alert('画像が大きすぎるため、テキストデータのみ保存されました。');
                                return retryResponse;
                            }
                        } catch (retryError) {
                            console.error('画像なしでの再試行も失敗:', retryError);
                        }
                    }
                    
                    // フォールバック: ローカルストレージに保存
                    this.requests.push(requestData);
                    this.saveToLocalStorage();
                    console.log('フォールバック: ローカルストレージに保存しました');
                    throw error;
                }
            }

            async updateRequest(id, requestData) {
                try {
                    console.log('スプレッドシートを更新中...', { id, requestData });
                    const response = await this.jsonpRequest(SCRIPT_URL, {
                        action: 'update',
                        id: id,
                        data: JSON.stringify(requestData)
                    });

                    console.log('スプレッドシート更新応答:', response);

                    if (response.status !== 'success') {
                        throw new Error(response.message || 'スプレッドシートの更新に失敗');
                    }
                    console.log('スプレッドシート更新成功:', response);

                    // ローカルデータも更新
                    const index = this.requests.findIndex(req => req.id.toString() === id.toString());
                    if (index !== -1) {
                        this.requests[index] = { ...requestData };
                        this.saveToLocalStorage();
                    }
                } catch (error) {
                    console.error('Update request error:', error);
                    // フォールバック: ローカルのみ更新
                    const index = this.requests.findIndex(req => req.id.toString() === id.toString());
                    if (index !== -1) {
                        this.requests[index] = { ...requestData };
                        this.saveToLocalStorage();
                    }
                    throw error;
                }
            }

            async deleteRequest(id) {
                if (confirm('この修正依頼を削除しますか？')) {
                    try {
                        console.log('スプレッドシートから削除中...', id);
                        const response = await this.jsonpRequest(SCRIPT_URL, {
                            action: 'delete',
                            id: id
                        });

                        console.log('スプレッドシート削除応答:', response);

                        if (response.status !== 'success') {
                            throw new Error(response.message || 'スプレッドシートからの削除に失敗');
                        }
                        console.log('スプレッドシート削除成功:', response);

                        // ローカルデータからも削除
                        this.requests = this.requests.filter(req => req.id !== id);
                        this.saveToLocalStorage();
                        this.renderTabs();
                        this.renderRequests();
                    } catch (error) {
                        console.error('Delete request error:', error);
                        // フォールバック: ローカルのみ削除
                        this.requests = this.requests.filter(req => req.id !== id);
                        this.saveToLocalStorage();
                        this.renderTabs();
                        this.renderRequests();
                    }
                }
            }

            async loadRequests() {
                try {
                    // スプレッドシートからデータを読み込み
                    try {
                        console.log('スプレッドシートからデータを読み込み中...');
                        const response = await this.jsonpRequest(SCRIPT_URL, { action: 'get' });
                        console.log('スプレッドシート読み込み応答:', JSON.stringify(response, null, 2));

                        if (response.status === 'success') {
                            this.requests = response.data || [];
                            // 日付フォーマットを修正
                            this.requests = this.requests.map(req => {
                                if (req.date && req.date.includes('/')) {
                                    // MM/DD/YYYY形式をYYYY-MM-DD形式に変換
                                    const dateParts = req.date.split('/');
                                    if (dateParts.length === 3) {
                                        req.date = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
                                    }
                                }
                                return req;
                            });
                            this.saveToLocalStorage(); // ローカルにもバックアップ
                            console.log('スプレッドシートからデータを読み込みました:', this.requests.length + '件');
                            return;
                        } else {
                            console.warn('スプレッドシート読み込み失敗:', response.message);
                        }
                    } catch (error) {
                        console.error('スプレッドシート読み込みエラー:', error);
                    }

                    // フォールバック: ローカルストレージから読み込み
                    this.requests = this.loadFromLocalStorage();
                    console.log('ローカルストレージからデータを読み込みました:', this.requests.length + '件');
                } catch (error) {
                    console.error('Load requests error:', error);
                    this.requests = [];
                }
            }

            editRequest(id) {
                const request = this.requests.find(req => req.id.toString() === id.toString());
                if (request) {
                    this.currentEditId = id.toString();
                    this.fillForm(request);
                    document.querySelector('.form-section h2').textContent = '修正依頼を編集';
                    document.querySelector('.submit-btn').textContent = '更新';
                    
                    // フォームの先頭にスクロール
                    document.querySelector('.form-section').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                } else {
                    console.error('編集対象のリクエストが見つかりません:', id);
                }
            }

            fillForm(request) {
                document.getElementById('page').value = request.page || '';
                document.getElementById('date').value = request.date || '';
                document.getElementById('content').value = request.content || '';
                document.getElementById('priority').value = request.priority || '';
                document.getElementById('category').value = request.category || '';

                document.getElementById('imageHelp').style.display = 'block';
                const dropZone = document.getElementById('dropZone');

                if (request.imageData) {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${request.imageData}" alt="現在の画像"><p style="margin-top: 5px; color: #666; font-size: 0.9em;">現在の画像: ${request.imageName || '画像ファイル'}</p>`;
                    dropZone.style.display = 'none';
                } else {
                    document.getElementById('imagePreview').innerHTML = '';
                    dropZone.style.display = 'block';
                }
            }

            resetForm() {
                document.getElementById('requestForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('imageHelp').style.display = 'none';
                document.getElementById('dropZone').style.display = 'block';
                this.setCurrentDate();
                this.currentEditId = null;
                document.querySelector('.form-section h2').textContent = '新規修正依頼';
                document.querySelector('.submit-btn').textContent = '登録';
            }

            handleImagePreview(event) {
                const file = event.target.files[0];
                this.displayImagePreview(file);
            }

            displayImagePreview(file) {
                const preview = document.getElementById('imagePreview');
                const dropZone = document.getElementById('dropZone');

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.innerHTML = `<img src="${e.target.result}" alt="プレビュー"><p style="margin-top: 5px; color: #666; font-size: 0.9em;">選択された画像: ${file.name}</p>`;
                        dropZone.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                    dropZone.style.display = 'block';
                }
            }

            setupDragAndDrop() {
                const dropZone = document.getElementById('dropZone');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.add('drag-over');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.remove('drag-over');
                    }, false);
                });

                dropZone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type.startsWith('image/')) {
                            this.displayImagePreview(file);
                            // ファイル入力にも設定
                            const imageInput = document.getElementById('image');
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            imageInput.files = dataTransfer.files;
                        }
                    }
                }, false);
            }

            setupPasteFunction() {
                document.addEventListener('paste', (e) => {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const file = items[i].getAsFile();
                            this.displayImagePreview(file);
                            // ファイル入力にも設定
                            const imageInput = document.getElementById('image');
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            imageInput.files = dataTransfer.files;
                            break;
                        }
                    }
                });
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            renderTabs() {
                const pages = [...new Set(this.requests.map(req => req.page))];
                const tabsContainer = document.getElementById('pageTabs');

                if (pages.length === 0) {
                    tabsContainer.innerHTML = '<div class="no-data">まだ修正依頼がありません</div>';
                    return;
                }

                tabsContainer.innerHTML = pages.map(page =>
                    `<div class="tab" data-page="${page}">${page}</div>`
                ).join('');

                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.renderRequests(e.target.dataset.page);
                    });
                });

                if (pages.length > 0) {
                    document.querySelector('.tab').classList.add('active');
                    this.renderRequests(pages[0]);
                }
            }

            renderRequests(selectedPage = null) {
                const contentContainer = document.getElementById('tabContent');

                if (this.requests.length === 0) {
                    contentContainer.innerHTML = '<div class="no-data">修正依頼がありません</div>';
                    return;
                }

                const filteredRequests = selectedPage
                    ? this.requests.filter(req => req.page === selectedPage)
                    : this.requests;

                if (filteredRequests.length === 0) {
                    contentContainer.innerHTML = '<div class="no-data">このページの修正依頼はありません</div>';
                    return;
                }

                const tableHTML = `
                    <table class="requests-table">
                        <thead>
                            <tr>
                                <th>記入日</th>
                                <th>修正内容</th>
                                <th>優先度</th>
                                <th>カテゴリ</th>
                                <th>画像</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredRequests.map(req => this.renderRequestRow(req)).join('')}
                        </tbody>
                    </table>
                `;

                contentContainer.innerHTML = tableHTML;
                this.setupTableEventListeners();
            }

            renderRequestRow(request) {
                const priorityClass = {
                    '高': 'priority-high',
                    '中': 'priority-medium',
                    '低': 'priority-low'
                }[request.priority] || '';

                const imageCell = request.imageData
                    ? `<img src="${request.imageData}" alt="添付画像" class="image-thumbnail" onclick="window.open('${request.imageData}', '_blank')">`
                    : '画像なし';

                // 日付を正しい形式で表示
                let displayDate = request.date || '';
                if (displayDate && displayDate.includes('-')) {
                    // YYYY-MM-DD形式をYYYY/MM/DD形式に変換
                    displayDate = displayDate.replace(/-/g, '/');
                }

                return `
                    <tr>
                        <td>${displayDate}</td>
                        <td>${request.content || ''}</td>
                        <td class="${priorityClass}">${request.priority || ''}</td>
                        <td>${request.category || ''}</td>
                        <td>${imageCell}</td>
                        <td>
                            <button class="edit-btn" data-id="${request.id}">編集</button>
                            <button class="delete-btn" data-id="${request.id}">削除</button>
                        </td>
                    </tr>
                `;
            }

            setupTableEventListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.editRequest(e.target.dataset.id);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.deleteRequest(e.target.dataset.id);
                    });
                });
            }

            // ローカルストレージ操作
            saveToLocalStorage() {
                localStorage.setItem('修正依頼データ', JSON.stringify(this.requests));
            }

            loadFromLocalStorage() {
                const data = localStorage.getItem('修正依頼データ');
                return data ? JSON.parse(data) : [];
            }
        }

        // アプリケーション開始
        document.addEventListener('DOMContentLoaded', () => {
            new RequestManager();
        });
    </script>
</body>

</html>
