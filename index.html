<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®æ­£ä¾é ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ä¿®æ­£ä¾é ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="version">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç‰ˆ - è¤‡æ•°äººã§å…±æœ‰å¯èƒ½ (Ver.02)</p>
        </header>

        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="form-section">
            <h2>æ–°è¦ä¿®æ­£ä¾é ¼</h2>
            <form id="requestForm">
                <div class="form-group">
                    <label for="page">ä¿®æ­£ãƒšãƒ¼ã‚¸:</label>
                    <select id="page" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</option>
                        <option value="å•†å“ä¸€è¦§">å•†å“ä¸€è¦§</option>
                        <option value="å•†å“è©³ç´°">å•†å“è©³ç´°</option>
                        <option value="ãŠå•ã„åˆã‚ã›">ãŠå•ã„åˆã‚ã›</option>
                        <option value="ä¼šç¤¾æ¦‚è¦">ä¼šç¤¾æ¦‚è¦</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date">è¨˜å…¥æ—¥:</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label for="content">ä¿®æ­£å†…å®¹:</label>
                    <textarea id="content" rows="4" required placeholder="ä¿®æ­£å†…å®¹ã‚’è©³ã—ãè¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                </div>

                <div class="form-group">
                    <label for="priority">å„ªå…ˆåº¦:</label>
                    <select id="priority" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="é«˜">é«˜</option>
                        <option value="ä¸­">ä¸­</option>
                        <option value="ä½">ä½</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="category">ä¿®æ­£ã‚«ãƒ†ã‚´ãƒª:</label>
                    <select id="category" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ä¿®æ­£">ä¿®æ­£</option>
                        <option value="è¿½åŠ ">è¿½åŠ </option>
                        <option value="å‰Šé™¤">å‰Šé™¤</option>
                        <option value="å¤‰æ›´">å¤‰æ›´</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="image">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</label>
                    <small style="color: #e74c3c; margin-bottom: 5px; display: block;">â€» ç”»åƒã¯300x300pxä»¥ä¸‹ã«è‡ªå‹•åœ§ç¸®ã•ã‚Œã¾ã™</small>
                    <small id="imageHelp" style="display: none; color: #666; margin-bottom: 5px;">â€»
                        ç”»åƒã‚’å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿é¸æŠã—ã¦ãã ã•ã„ã€‚é¸æŠã—ãªã„å ´åˆã¯æ—¢å­˜ã®ç”»åƒãŒä¿æŒã•ã‚Œã¾ã™ã€‚</small>
                    <input type="file" id="image" accept="image/*">
                    <div id="dropZone" class="drop-zone">
                        <p>ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯<br>Ctrl+V ã§ãƒšãƒ¼ã‚¹ãƒˆ<br><small>ï¼ˆè‡ªå‹•ã§å°ã•ãåœ§ç¸®ã•ã‚Œã¾ã™ï¼‰</small></p>
                    </div>
                    <div id="imagePreview"></div>
                    <button type="button" id="clearImage" class="clear-btn" style="display: none;">ç”»åƒã‚’ã‚¯ãƒªã‚¢</button>
                </div>

                <button type="submit" class="submit-btn">ç™»éŒ²</button>
                <div id="loading" class="loading" style="display: none;">ä¿å­˜ä¸­...</div>
            </form>
        </div>

        <!-- ã‚¿ãƒ–è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="tabs-section">
            <h2>ä¿®æ­£ä¾é ¼ä¸€è¦§</h2>
            <div class="tabs" id="pageTabs"></div>
            <div class="tab-content" id="tabContent"></div>
        </div>
    </div>

    <script>
        // Google Apps Script Web App URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxXyS7w8vPAhNFhZ2gd_p6SPeEGE97mFAQmqFeo8ZioJFODqtUeVoPMbAeqORAzOCv9jA/exec';

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¯ãƒ©ã‚¹
        class RequestManager {
            constructor() {
                this.requests = [];
                this.currentEditId = null;
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.setCurrentDate();
                await this.loadRequests();
                this.renderTabs();
                this.renderRequests();
            }

            setupEventListeners() {
                const form = document.getElementById('requestForm');
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleSubmit();
                    });
                }

                const imageInput = document.getElementById('image');
                if (imageInput) {
                    imageInput.addEventListener('change', (e) => {
                        this.handleImagePreview(e);
                    });
                }

                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
                this.setupDragAndDrop();
                
                // ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆæ©Ÿèƒ½
                this.setupPasteFunction();
                
                // ç”»åƒã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
                document.getElementById('clearImage').addEventListener('click', () => {
                    this.clearImage();
                });
            }

            setCurrentDate() {
                const today = this.getCurrentDateString();
                document.getElementById('date').value = today;
            }

            getCurrentDateString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            async handleSubmit() {
                const loading = document.getElementById('loading');
                loading.style.display = 'block';

                try {
                    const formData = await this.getFormData();

                    if (this.currentEditId) {
                        await this.updateRequest(this.currentEditId, formData);
                        this.currentEditId = null;
                    } else {
                        await this.addRequest(formData);
                    }

                    this.resetForm();
                    await this.loadRequests();
                    this.renderTabs();
                    this.renderRequests();

                    alert('ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    
                    let errorMessage = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    if (error.message.includes('too large')) {
                        errorMessage = 'ç”»åƒãŒå¤§ãã™ãã¾ã™ã€‚ã‚ˆã‚Šå°ã•ãªç”»åƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚';
                    } else if (error.message.includes('timeout')) {
                        errorMessage = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    }
                    
                    alert(errorMessage + '\nãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã™ã€‚');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    const formData = await this.getFormData();
                    this.requests.push(formData);
                    this.saveToLocalStorage();
                    this.renderTabs();
                    this.renderRequests();
                } finally {
                    loading.style.display = 'none';
                }
            }

            async getFormData() {
                const imageFile = document.getElementById('image').files[0];
                let imageData = null;
                let imageName = null;

                if (imageFile) {
                    imageData = await this.fileToBase64(imageFile);
                    imageName = imageFile.name;
                } else if (this.currentEditId) {
                    const existingRequest = this.requests.find(req => req.id === this.currentEditId);
                    if (existingRequest) {
                        imageData = existingRequest.imageData;
                        imageName = existingRequest.imageName;
                    }
                }

                return {
                    id: this.currentEditId || Date.now().toString(),
                    page: document.getElementById('page').value,
                    date: document.getElementById('date').value,
                    content: document.getElementById('content').value,
                    priority: document.getElementById('priority').value,
                    category: document.getElementById('category').value,
                    imageData: imageData,
                    imageName: imageName,
                    createdAt: this.getCurrentDateString()
                };
            }

            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    // ã™ã¹ã¦ã®ç”»åƒã‚’åœ§ç¸®ï¼ˆURLåˆ¶é™å¯¾å¿œï¼‰
                    console.log(`å…ƒç”»åƒã‚µã‚¤ã‚º: ${Math.round(file.size / 1024)}KB`);
                    this.compressImage(file).then(resolve).catch(reject);
                });
            }

            compressImage(file) {
                return new Promise((resolve, reject) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // éå¸¸ã«å°ã•ãªã‚µã‚¤ã‚ºã«åˆ¶é™ï¼ˆURLåˆ¶é™å¯¾å¿œï¼‰
                        const maxWidth = 300;
                        const maxHeight = 300;
                        let { width, height } = img;
                        
                        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // ç”»åƒã‚’æç”»
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // æ®µéšçš„ã«å“è³ªã‚’ä¸‹ã’ã¦åœ§ç¸®
                        let quality = 0.3;
                        let compressedDataUrl;
                        let attempts = 0;
                        
                        do {
                            compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                            console.log(`åœ§ç¸®è©¦è¡Œ ${attempts + 1}: å“è³ª${quality}, ã‚µã‚¤ã‚º${Math.round(compressedDataUrl.length / 1024)}KB`);
                            
                            if (compressedDataUrl.length < 15000) { // ç´„11KBã®Base64ãƒ‡ãƒ¼ã‚¿
                                break;
                            }
                            
                            quality -= 0.05;
                            attempts++;
                        } while (quality > 0.1 && attempts < 5);
                        
                        console.log(`ç”»åƒã‚’åœ§ç¸®ã—ã¾ã—ãŸ: ${file.size} bytes â†’ ${Math.round(compressedDataUrl.length * 0.75)} bytes (å“è³ª: ${quality})`);
                        resolve(compressedDataUrl);
                    };
                    
                    img.onerror = reject;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // JSONPæ–¹å¼ã§Google Apps Scriptã«ã‚¢ã‚¯ã‚»ã‚¹
            jsonpRequest(url, params = {}) {
                return new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

                    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ä½œæˆ
                    window[callbackName] = function (data) {
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        resolve(data);
                    };

                    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯åã‚’è¿½åŠ 
                    params.callback = callbackName;

                    // URLã®é•·ã•ã‚’ãƒã‚§ãƒƒã‚¯
                    const queryString = Object.keys(params)
                        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
                        .join('&');
                    
                    const fullUrl = url + '?' + queryString;
                    
                    console.log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLé•·: ${fullUrl.length} æ–‡å­—`);
                    
                    // URLãŒé•·ã™ãã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼ˆã‚ˆã‚Šå³ã—ã„åˆ¶é™ï¼‰
                    if (fullUrl.length > 6000) {
                        console.error('URL too long:', fullUrl.length, 'characters');
                        reject(new Error('Request too large - image data exceeds URL limit'));
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = fullUrl;
                    script.onerror = () => {
                        delete window[callbackName];
                        if (document.body.contains(script)) {
                            document.body.removeChild(script);
                        }
                        reject(new Error('JSONP request failed - possibly too large'));
                    };

                    document.body.appendChild(script);

                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.body.contains(script)) {
                                document.body.removeChild(script);
                            }
                            reject(new Error('JSONP request timeout'));
                        }
                    }, 20000); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’20ç§’ã«å»¶é•·
                });
            }

            async addRequest(requestData) {
                try {
                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ä¸­...', {
                        ...requestData,
                        imageData: requestData.imageData ? `[ç”»åƒãƒ‡ãƒ¼ã‚¿: ${Math.round(requestData.imageData.length / 1024)}KB]` : null
                    });
                    
                    // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã‚‹å ´åˆã®è­¦å‘Š
                    if (requestData.imageData && requestData.imageData.length > 100000) {
                        console.warn('å¤§ããªç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­:', Math.round(requestData.imageData.length / 1024), 'KB');
                    }
                    
                    const response = await this.jsonpRequest(SCRIPT_URL, {
                        action: 'add',
                        data: JSON.stringify(requestData)
                    });

                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®å¿œç­”:', JSON.stringify(response, null, 2));

                    if (response.status === 'success') {
                        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜æˆåŠŸ:', JSON.stringify(response, null, 2));
                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                        this.requests.push(requestData);
                        this.saveToLocalStorage();
                        return response;
                    } else {
                        throw new Error(response.message || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®ä¿å­˜ã«å¤±æ•—');
                    }
                } catch (error) {
                    console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    
                    // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒåŸå› ã®å ´åˆã¯ç”»åƒãªã—ã§å†è©¦è¡Œ
                    if (error.message.includes('too large') && requestData.imageData) {
                        console.log('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒå¤§ãã™ãã‚‹ãŸã‚ã€ç”»åƒãªã—ã§å†è©¦è¡Œã—ã¾ã™');
                        try {
                            const dataWithoutImage = { ...requestData, imageData: null, imageName: null };
                            const retryResponse = await this.jsonpRequest(SCRIPT_URL, {
                                action: 'add',
                                data: JSON.stringify(dataWithoutImage)
                            });
                            
                            if (retryResponse.status === 'success') {
                                console.log('ç”»åƒãªã—ã§ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸ');
                                this.requests.push(dataWithoutImage);
                                this.saveToLocalStorage();
                                alert('ç”»åƒãŒå¤§ãã™ãã‚‹ãŸã‚ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
                                return retryResponse;
                            }
                        } catch (retryError) {
                            console.error('ç”»åƒãªã—ã§ã®å†è©¦è¡Œã‚‚å¤±æ•—:', retryError);
                        }
                    }
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                    this.requests.push(requestData);
                    this.saveToLocalStorage();
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ');
                    throw error;
                }
            }

            async updateRequest(id, requestData) {
                try {
                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°ä¸­...', { id, requestData });
                    const response = await this.jsonpRequest(SCRIPT_URL, {
                        action: 'update',
                        id: id,
                        data: JSON.stringify(requestData)
                    });

                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°å¿œç­”:', response);

                    if (response.status !== 'success') {
                        throw new Error(response.message || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ›´æ–°ã«å¤±æ•—');
                    }
                    console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°æˆåŠŸ:', response);

                    // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    const index = this.requests.findIndex(req => req.id.toString() === id.toString());
                    if (index !== -1) {
                        this.requests[index] = { ...requestData };
                        this.saveToLocalStorage();
                    }
                } catch (error) {
                    console.error('Update request error:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿æ›´æ–°
                    const index = this.requests.findIndex(req => req.id.toString() === id.toString());
                    if (index !== -1) {
                        this.requests[index] = { ...requestData };
                        this.saveToLocalStorage();
                    }
                    throw error;
                }
            }

            async deleteRequest(id) {
                if (confirm('ã“ã®ä¿®æ­£ä¾é ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    try {
                        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ä¸­...', id);
                        const response = await this.jsonpRequest(SCRIPT_URL, {
                            action: 'delete',
                            id: id
                        });

                        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå‰Šé™¤å¿œç­”:', response);

                        if (response.status !== 'success') {
                            throw new Error(response.message || 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®å‰Šé™¤ã«å¤±æ•—');
                        }
                        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆå‰Šé™¤æˆåŠŸ:', response);

                        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚‚å‰Šé™¤
                        this.requests = this.requests.filter(req => req.id !== id);
                        this.saveToLocalStorage();
                        this.renderTabs();
                        this.renderRequests();
                    } catch (error) {
                        console.error('Delete request error:', error);
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿å‰Šé™¤
                        this.requests = this.requests.filter(req => req.id !== id);
                        this.saveToLocalStorage();
                        this.renderTabs();
                        this.renderRequests();
                    }
                }
            }

            async loadRequests() {
                try {
                    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                    try {
                        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                        const response = await this.jsonpRequest(SCRIPT_URL, { action: 'get' });
                        console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¿œç­”:', JSON.stringify(response, null, 2));

                        if (response.status === 'success') {
                            this.requests = response.data || [];
                            // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä¿®æ­£
                            this.requests = this.requests.map(req => {
                                if (req.date) {
                                    // ISOå½¢å¼ã®å ´åˆã¯æ—¥ä»˜éƒ¨åˆ†ã®ã¿æŠ½å‡º
                                    if (req.date.includes('T')) {
                                        req.date = req.date.split('T')[0];
                                    }
                                    // MM/DD/YYYYå½¢å¼ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
                                    else if (req.date.includes('/')) {
                                        const dateParts = req.date.split('/');
                                        if (dateParts.length === 3) {
                                            req.date = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
                                        }
                                    }
                                }
                                return req;
                            });
                            this.saveToLocalStorage(); // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                            console.log('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', this.requests.length + 'ä»¶');
                            return;
                        } else {
                            console.warn('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—:', response.message);
                        }
                    } catch (error) {
                        console.error('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    }

                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿
                    this.requests = this.loadFromLocalStorage();
                    console.log('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', this.requests.length + 'ä»¶');
                } catch (error) {
                    console.error('Load requests error:', error);
                    this.requests = [];
                }
            }

            editRequest(id) {
                const request = this.requests.find(req => req.id.toString() === id.toString());
                if (request) {
                    this.currentEditId = id.toString();
                    this.fillForm(request);
                    document.querySelector('.form-section h2').textContent = 'ä¿®æ­£ä¾é ¼ã‚’ç·¨é›†';
                    document.querySelector('.submit-btn').textContent = 'æ›´æ–°';
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã®å…ˆé ­ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    document.querySelector('.form-section').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                } else {
                    console.error('ç·¨é›†å¯¾è±¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', id);
                }
            }

            fillForm(request) {
                document.getElementById('page').value = request.page || '';
                document.getElementById('date').value = request.date || '';
                document.getElementById('content').value = request.content || '';
                document.getElementById('priority').value = request.priority || '';
                document.getElementById('category').value = request.category || '';

                document.getElementById('imageHelp').style.display = 'block';
                const dropZone = document.getElementById('dropZone');
                const clearBtn = document.getElementById('clearImage');

                // ç”»åƒè¡¨ç¤ºã®æ”¹å–„ï¼ˆGoogle Driveå¯¾å¿œï¼‰
                if (request.imageData) {
                    // å¾“æ¥ã®Base64ãƒ‡ãƒ¼ã‚¿
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${request.imageData}" alt="ç¾åœ¨ã®ç”»åƒ"><p style="margin-top: 5px; color: #666; font-size: 0.9em;">ç¾åœ¨ã®ç”»åƒ: ${request.imageName || 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«'}</p>`;
                    dropZone.style.display = 'none';
                    clearBtn.style.display = 'inline-block';
                } else if (request.thumbnailUrl && request.imageUrl) {
                    // Google Driveç”»åƒ
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${request.thumbnailUrl}" alt="ç¾åœ¨ã®ç”»åƒ"><p style="margin-top: 5px; color: #666; font-size: 0.9em;">ç¾åœ¨ã®ç”»åƒ: ${request.imageName || 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«'} <a href="${request.imageUrl}" target="_blank">(Google Driveã§é–‹ã)</a></p>`;
                    dropZone.style.display = 'none';
                    clearBtn.style.display = 'inline-block';
                } else if (request.imageUrl) {
                    // Google Driveã®URLï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ãªã—ï¼‰
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<p style="margin-top: 5px; color: #666; font-size: 0.9em;">ğŸ“· <a href="${request.imageUrl}" target="_blank">Google Driveã®ç”»åƒã‚’è¦‹ã‚‹</a></p>`;
                    dropZone.style.display = 'none';
                    clearBtn.style.display = 'inline-block';
                } else {
                    document.getElementById('imagePreview').innerHTML = '';
                    dropZone.style.display = 'block';
                    clearBtn.style.display = 'none';
                }
            }

            resetForm() {
                document.getElementById('requestForm').reset();
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('imageHelp').style.display = 'none';
                document.getElementById('dropZone').style.display = 'block';
                this.setCurrentDate();
                this.currentEditId = null;
                document.querySelector('.form-section h2').textContent = 'æ–°è¦ä¿®æ­£ä¾é ¼';
                document.querySelector('.submit-btn').textContent = 'ç™»éŒ²';
            }

            handleImagePreview(event) {
                const file = event.target.files[0];
                this.displayImagePreview(file);
            }

            displayImagePreview(file) {
                const preview = document.getElementById('imagePreview');
                const dropZone = document.getElementById('dropZone');
                const clearBtn = document.getElementById('clearImage');

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.innerHTML = `<img src="${e.target.result}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"><p style="margin-top: 5px; color: #666; font-size: 0.9em;">é¸æŠã•ã‚ŒãŸç”»åƒ: ${file.name} (${Math.round(file.size / 1024)}KB)</p>`;
                        dropZone.style.display = 'none';
                        clearBtn.style.display = 'inline-block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.innerHTML = '';
                    dropZone.style.display = 'block';
                    clearBtn.style.display = 'none';
                }
            }

            clearImage() {
                document.getElementById('image').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('dropZone').style.display = 'block';
                document.getElementById('clearImage').style.display = 'none';
            }

            setupDragAndDrop() {
                const dropZone = document.getElementById('dropZone');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.add('drag-over');
                    }, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, () => {
                        dropZone.classList.remove('drag-over');
                    }, false);
                });

                dropZone.addEventListener('drop', (e) => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type.startsWith('image/')) {
                            this.displayImagePreview(file);
                            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã«ã‚‚è¨­å®š
                            const imageInput = document.getElementById('image');
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            imageInput.files = dataTransfer.files;
                        }
                    }
                }, false);
            }

            setupPasteFunction() {
                document.addEventListener('paste', (e) => {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const file = items[i].getAsFile();
                            this.displayImagePreview(file);
                            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã«ã‚‚è¨­å®š
                            const imageInput = document.getElementById('image');
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            imageInput.files = dataTransfer.files;
                            break;
                        }
                    }
                });
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            renderTabs() {
                const pages = [...new Set(this.requests.map(req => req.page))];
                const tabsContainer = document.getElementById('pageTabs');

                if (pages.length === 0) {
                    tabsContainer.innerHTML = '<div class="no-data">ã¾ã ä¿®æ­£ä¾é ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                tabsContainer.innerHTML = pages.map(page =>
                    `<div class="tab" data-page="${page}">${page}</div>`
                ).join('');

                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        e.target.classList.add('active');
                        this.renderRequests(e.target.dataset.page);
                    });
                });

                if (pages.length > 0) {
                    document.querySelector('.tab').classList.add('active');
                    this.renderRequests(pages[0]);
                }
            }

            renderRequests(selectedPage = null) {
                const contentContainer = document.getElementById('tabContent');

                if (this.requests.length === 0) {
                    contentContainer.innerHTML = '<div class="no-data">ä¿®æ­£ä¾é ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                const filteredRequests = selectedPage
                    ? this.requests.filter(req => req.page === selectedPage)
                    : this.requests;

                if (filteredRequests.length === 0) {
                    contentContainer.innerHTML = '<div class="no-data">ã“ã®ãƒšãƒ¼ã‚¸ã®ä¿®æ­£ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                const tableHTML = `
                    <table class="requests-table">
                        <thead>
                            <tr>
                                <th>è¨˜å…¥æ—¥</th>
                                <th>ä¿®æ­£å†…å®¹</th>
                                <th>å„ªå…ˆåº¦</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>ç”»åƒ</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredRequests.map(req => this.renderRequestRow(req)).join('')}
                        </tbody>
                    </table>
                `;

                contentContainer.innerHTML = tableHTML;
                this.setupTableEventListeners();
            }

            renderRequestRow(request) {
                const priorityClass = {
                    'é«˜': 'priority-high',
                    'ä¸­': 'priority-medium',
                    'ä½': 'priority-low'
                }[request.priority] || '';

                // ç”»åƒè¡¨ç¤ºã®æ”¹å–„ï¼ˆGoogle Driveå¯¾å¿œï¼‰
                let imageCell = 'ç”»åƒãªã—';
                if (request.imageData) {
                    // å¾“æ¥ã®Base64ãƒ‡ãƒ¼ã‚¿
                    imageCell = `<img src="${request.imageData}" alt="æ·»ä»˜ç”»åƒ" class="image-thumbnail" onclick="window.open('${request.imageData}', '_blank')">`;
                } else if (request.thumbnailUrl && request.imageUrl) {
                    // Google Driveç”»åƒ
                    imageCell = `<img src="${request.thumbnailUrl}" alt="æ·»ä»˜ç”»åƒ" class="image-thumbnail" onclick="window.open('${request.imageUrl}', '_blank')" title="ã‚¯ãƒªãƒƒã‚¯ã§Google Driveã§é–‹ã">`;
                } else if (request.imageUrl) {
                    // Google Driveã®URLï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ãªã—ï¼‰
                    imageCell = `<a href="${request.imageUrl}" target="_blank" class="drive-link">ğŸ“· ç”»åƒã‚’è¦‹ã‚‹</a>`;
                }

                // æ—¥ä»˜ã‚’æ­£ã—ã„å½¢å¼ã§è¡¨ç¤º
                let displayDate = request.date || '';
                if (displayDate) {
                    // YYYY-MM-DDå½¢å¼ã‚’YYYY/MM/DDå½¢å¼ã«å¤‰æ›
                    if (displayDate.includes('-')) {
                        displayDate = displayDate.replace(/-/g, '/');
                    }
                    // ISOå½¢å¼ã®å ´åˆã¯æ—¥ä»˜éƒ¨åˆ†ã®ã¿æŠ½å‡º
                    if (displayDate.includes('T')) {
                        displayDate = displayDate.split('T')[0].replace(/-/g, '/');
                    }
                }

                return `
                    <tr>
                        <td>${displayDate}</td>
                        <td>${request.content || ''}</td>
                        <td class="${priorityClass}">${request.priority || ''}</td>
                        <td>${request.category || ''}</td>
                        <td>${imageCell}</td>
                        <td>
                            <button class="edit-btn" data-id="${request.id}">ç·¨é›†</button>
                            <button class="delete-btn" data-id="${request.id}">å‰Šé™¤</button>
                        </td>
                    </tr>
                `;
            }

            setupTableEventListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.editRequest(e.target.dataset.id);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.deleteRequest(e.target.dataset.id);
                    });
                });
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æ“ä½œ
            saveToLocalStorage() {
                localStorage.setItem('ä¿®æ­£ä¾é ¼ãƒ‡ãƒ¼ã‚¿', JSON.stringify(this.requests));
            }

            loadFromLocalStorage() {
                const data = localStorage.getItem('ä¿®æ­£ä¾é ¼ãƒ‡ãƒ¼ã‚¿');
                return data ? JSON.parse(data) : [];
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            new RequestManager();
        });
    </script>
</body>

</html>
